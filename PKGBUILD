# Maintainer: Nomadcxx <noovie@gmail.com>
pkgname=searxng-rama
_pkgname=searxng
pkgver=r9135.8bf600c
pkgrel=2
pkgdesc="SearXNG RAMA Edition - Pre-configured SearXNG with custom theme and systemd service"
arch=('any')
url="https://github.com/Nomadcxx/searxng-RAMA"
license=('AGPL3')
depends=('python' 'systemd')
makedepends=('openssl' 'git' 'python-virtualenv' 'npm' 'gcc' 'make' 'libvips' 'python' 'pkgconf')
optdepends=(
    'redis: Caching support for improved performance'
    'valkey: Alternative caching support'
    'libmagic: File type detection for uploads'
    'p7zip: Archive support for file upload'
)
provides=('searxng')
conflicts=('searx' 'searx-git' 'searxng')
backup=('opt/searxng-rama/searx/settings.yml')
install=${pkgname}.install

_giturl="https://github.com/searxng/searxng"
_gitbranch="master"
source=(git+$_giturl#branch=$_gitbranch
        git+https://github.com/Nomadcxx/searxng-RAMA.git)
b2sums=('SKIP' 'SKIP')

pkgver() {
  cd $_pkgname
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short=7 HEAD)"
}

build() {
  cd "$srcdir/$_pkgname"

  # Apply RAMA theme customizations to source
  msg2 "Applying RAMA theme customizations..."

  # Copy RAMA definitions.less to client source (this is where theme is built from)
  cp "${srcdir}/searxng-RAMA/theme/rama/definitions.less" "client/simple/src/less/definitions.less"

  # Copy RAMA branding assets to client source BEFORE building (vite generates assets from these)
  msg2 "Installing RAMA branding assets to client source..."

  # Ensure brand directory exists
  mkdir -p "client/simple/src/brand"

  # Create a minimal placeholder searxng.svg (vite plugin needs this, but we'll overwrite PNG after build)
  # This prevents vite build from failing if searxng.svg is missing
  cat > "client/simple/src/brand/searxng.svg" << 'EOF'
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20">
  <text x="5" y="15" font-family="monospace" font-size="12" fill="#ef233c">SEARXNG</text>
</svg>
EOF

  # Copy RAMA red favicon SVG - vite will generate favicon.png and favicon.svg from this
  if [ -f "${srcdir}/searxng-RAMA/assets/favicon.svg" ]; then
    cp "${srcdir}/searxng-RAMA/assets/favicon.svg" "client/simple/src/brand/searxng-wordmark.svg"
  fi

  # Copy empty favicon SVG to source (vite plugin processes this)
  if [ -f "${srcdir}/searxng-RAMA/assets/empty_favicon.svg" ]; then
    mkdir -p "client/simple/src/svg"
    cp "${srcdir}/searxng-RAMA/assets/empty_favicon.svg" "client/simple/src/svg/empty_favicon.svg"
  fi

  # Build the theme with RAMA styling
  msg2 "Building RAMA theme..."
  cd client/simple

  # Install npm dependencies - skip postinstall scripts to avoid sharp native build issues
  npm install --no-audit --no-fund --ignore-scripts

  # Build only the vite part (CSS compilation) - skip icons which needs sharp
  npx vite build

  cd "$srcdir/$_pkgname"

  # Copy custom RAMA assets AFTER vite build (overwrite generated files)
  msg2 "Installing custom RAMA logo and favicon..."

  # Copy custom ASCII-style "SEARXNG" logo PNG (overwrites vite-generated searxng.png)
  if [ -f "${srcdir}/searxng-RAMA/brand/searxng.png" ]; then
    cp "${srcdir}/searxng-RAMA/brand/searxng.png" "searx/static/themes/simple/img/searxng.png"
  fi

  # Copy red favicon files directly (ensure they're present)
  if [ -f "${srcdir}/searxng-RAMA/assets/favicon.svg" ]; then
    cp "${srcdir}/searxng-RAMA/assets/favicon.svg" "searx/static/themes/simple/img/favicon.svg"
  fi

  if [ -f "${srcdir}/searxng-RAMA/assets/favicon.png" ]; then
    cp "${srcdir}/searxng-RAMA/assets/favicon.png" "searx/static/themes/simple/img/favicon.png"
  fi

  if [ -f "${srcdir}/searxng-RAMA/assets/empty_favicon.svg" ]; then
    cp "${srcdir}/searxng-RAMA/assets/empty_favicon.svg" "searx/static/themes/simple/img/empty_favicon.svg"
  fi

  # Create version file
  cat > searx/version_frozen.py << EOF
# THIS FILE IS GENERATED BY THE BUILD PROCESS
# DO NOT EDIT IT MANUALLY

VERSION_STRING = "1.0.0-RAMA"
VERSION_TAG = "1.0.0-RAMA"
DOCKER_TAG = "1.0.0-RAMA"
GIT_URL = "${_giturl}"
GIT_BRANCH = "${_gitbranch}"
EOF
}

package() {
  cd "$srcdir/$_pkgname"

  # Create installation directory
  install -dm755 "$pkgdir/opt/searxng-rama"

  # Copy SearXNG source files (includes built theme in searx/static/themes/simple/)
  msg2 "Copying SearXNG files..."
  cp -r searx "$pkgdir/opt/searxng-rama/"

  # Copy additional directories if they exist
  for dir in dockerfiles docs utils; do
    if [ -d "$dir" ]; then
      cp -r "$dir" "$pkgdir/opt/searxng-rama/"
    fi
  done

  # Copy essential files
  for file in Makefile manage requirements.txt requirements-dev.txt setup.py babel.cfg; do
    if [ -f "$file" ]; then
      install -Dm644 "$file" "$pkgdir/opt/searxng-rama/$file"
    fi
  done

  # Copy .git directory for version info
  if [ -d ".git" ]; then
    cp -r .git "$pkgdir/opt/searxng-rama/"
  fi

  # RAMA assets already copied to source in build() and compiled by vite

  # Modify settings.yml with RAMA defaults
  msg2 "Configuring settings..."
  local settings_file="${pkgdir}/opt/searxng-rama/searx/settings.yml"

  # Generate secret key
  local secret_key="$(openssl rand -hex 32)"

  # Modify settings
  sed -i "s/secret_key: \"ultrasecretkey\"/secret_key: \"${secret_key}\"/" "$settings_file"
  sed -i "s/port: 8888/port: 8855/" "$settings_file"
  sed -i 's/bind_address: "127.0.0.1"/bind_address: "0.0.0.0"/' "$settings_file"
  sed -i 's/instance_name: "SearXNG"/instance_name: "SearXNG RAMA Edition"/' "$settings_file"

  # Create Python virtual environment
  msg2 "Creating Python virtual environment..."
  export PIP_DISABLE_PIP_VERSION_CHECK=1
  export PYTHONDONTWRITEBYTECODE=1
  python -m venv "$pkgdir/opt/searxng-rama/venv"

  # Install dependencies in venv
  msg2 "Installing Python dependencies..."
  "$pkgdir/opt/searxng-rama/venv/bin/pip" install --upgrade pip wheel
  "$pkgdir/opt/searxng-rama/venv/bin/pip" install -r "${srcdir}/${_pkgname}/requirements.txt"

  # Fix venv shebangs to use final install path (remove pkgdir prefix)
  msg2 "Fixing virtual environment paths..."
  find "$pkgdir/opt/searxng-rama/venv/bin" -type f -exec sed -i "s|${pkgdir}||g" {} +
  if [ -f "$pkgdir/opt/searxng-rama/venv/pyvenv.cfg" ]; then
    sed -i "s|${pkgdir}||g" "$pkgdir/opt/searxng-rama/venv/pyvenv.cfg"
  fi

  # Clean up bytecode
  find "$pkgdir/opt/searxng-rama/venv" -type f -name "*.py[co]" -delete
  find "$pkgdir/opt/searxng-rama/venv" -type d -name "__pycache__" -delete

  # Create executable wrapper
  msg2 "Creating wrapper script..."
  install -dm755 "$pkgdir/usr/bin"
  cat > "$pkgdir/usr/bin/searxng-rama-run" << 'EOF'
#!/bin/bash
export SEARXNG_SETTINGS_PATH=/opt/searxng-rama/searx/settings.yml
cd /opt/searxng-rama
exec /opt/searxng-rama/venv/bin/python -m searx.webapp "$@"
EOF
  chmod +x "$pkgdir/usr/bin/searxng-rama-run"

  # Install systemd service
  msg2 "Installing systemd service..."
  install -dm755 "${pkgdir}/etc/systemd/system"
  cat > "${pkgdir}/etc/systemd/system/searxng-rama.service" << 'EOF'
[Unit]
Description=RAMA SearXNG
After=network.target

[Service]
Type=simple
User=searxng
WorkingDirectory=/opt/searxng-rama
Environment="SEARXNG_SETTINGS_PATH=/opt/searxng-rama/searx/settings.yml"
ExecStart=/usr/bin/searxng-rama-run
Restart=on-failure
RestartSec=5

# Permissions for database writes
ReadWritePaths=/opt/searxng-rama

[Install]
WantedBy=multi-user.target
EOF

  # Install licenses
  install -Dm644 "${srcdir}/${_pkgname}/LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  if [ -f "${srcdir}/searxng-RAMA/LICENSE" ]; then
    install -Dm644 "${srcdir}/searxng-RAMA/LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/RAMA_LICENSE"
  fi

  # Install documentation
  if [ -f "${srcdir}/searxng-RAMA/README.md" ]; then
    install -Dm644 "${srcdir}/searxng-RAMA/README.md" "${pkgdir}/usr/share/doc/${pkgname}/README.md"
  fi
}
